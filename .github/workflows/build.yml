name: CAPlayground V15 (Safe PBX Edit)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # 1. EXTRACT
      - name: Extract Source
        run: |
          if [ -f "ios_source.tar.gz" ]; then
            tar -xzf ios_source.tar.gz
          elif [ -d "ios" ]; then
            echo "üìÇ Using existing 'ios' folder."
          else
            echo "‚ùå Error: No source found."
            exit 1
          fi

      # 2. MASTER PATCH (Source Code Only)
      - name: Apply Master Patch
        run: |
          cd ios
          # A. Fix Median .zip bug
          find . -name "LEANWebViewController.m" -exec sed -i '' 's/stringByAppendingPathExtension:@"zip"//g' {} +
          find . -name "GNJSBridgeInterface.m" -exec sed -i '' 's/stringByAppendingPathExtension:@"zip"//g' {} +

          # B. Remove MedianIcons Imports
          grep -rl "MedianIcons" . | while read file; do
            if [[ "$file" != *"Pods"* ]]; then
              sed -i '' '/MedianIcons/d' "$file"
            fi
          done

      # 3. SAFE PROJECT EDITING (Python)
      # This replaces the dangerous 'sed' commands on project.pbxproj
      - name: Safe Project Fix
        run: |
          cd ios
          PROJECT=$(find . -name "*.xcodeproj" | head -n 1)
          PBXPROJ="$PROJECT/project.pbxproj"
          
          echo "üêç Running Python to safely edit $PBXPROJ..."
          
          cat <<EOF > fix_project.py
          import sys
          
          path = sys.argv[1]
          
          with open(path, 'r', encoding='utf-8') as f:
              lines = f.readlines()
          
          new_lines = []
          for line in lines:
              # 1. Remove Entitlements (Fixes SideStore install)
              if "CODE_SIGN_ENTITLEMENTS" in line:
                  continue
              # 2. Remove Pods Manifest Check (Fixes Pod mismatch error)
              if "Check Pods Manifest.lock" in line:
                  continue
              # 3. Remove the shell script block execution for the manifest check
              if "ShellScript" in line and "Manifest.lock" in line:
                  continue
              
              new_lines.append(line)
          
          with open(path, 'w', encoding='utf-8') as f:
              f.writelines(new_lines)
          
          print("‚úÖ Project file patched successfully.")
          EOF
          
          python3 fix_project.py "$PBXPROJ"

      # 4. MODIFY INFO.PLIST
      - name: Modify Info.plist
        run: |
          cd ios
          PLIST=$(find . -name "Info.plist" | head -n 1)
          if [ -n "$PLIST" ]; then
            /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName CAPlayground" "$PLIST" 2>/dev/null || /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string CAPlayground" "$PLIST"
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.nightvibes3.caplayground" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :UIFileSharingEnabled bool true" "$PLIST" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :UIFileSharingEnabled true" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :LSSupportsOpeningDocumentsInPlace true" "$PLIST"
          fi

      # 5. BUILD APP
      - name: Build App
        run: |
          cd ios
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME=$(basename "$WORKSPACE" .xcworkspace)
          
          echo "üöÄ Building $SCHEME..."
          
          xcodebuild build \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build/ \
            -arch arm64 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            GCC_GENERATE_DEBUGGING_SYMBOLS=NO \
            STRIP_INSTALLED_PRODUCT=YES

      # 6. PACKAGE IPA
      - name: Package IPA
        run: |
          cd ios
          mkdir Payload
          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå Build failed."
            exit 1
          fi
          
          cp -r "$APP_PATH" Payload/
          rm -rf "Payload/$(basename "$APP_PATH")/_CodeSignature"
          
          IPA_NAME="CAPlayground_v1.0.${{ github.run_number }}.ipa"
          zip -r -y -X "$IPA_NAME" Payload

          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV

      # 7. UPLOAD
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: CAPlayground-V15-App
          path: ios/${{ env.IPA_NAME }}
