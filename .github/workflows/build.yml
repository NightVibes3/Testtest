name: CAPlayground V6 (Identity Shift + Fix)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # 1. EXTRACT SOURCE (Handles your .tar.gz)
      - name: Extract Source
        run: |
          if [ -f "ios_source.tar.gz" ]; then
            tar -xzf ios_source.tar.gz
          elif [ -d "ios" ]; then
            echo "ðŸ“‚ Using existing 'ios' folder."
          else
            echo "âŒ Error: No source found (ios_source.tar.gz or ios folder missing)."
            exit 1
          fi

      # 2. BYPASS POD INSTALL (THE FIX for your error)
      # We skip 'pod install' to avoid the private repo login error.
      # instead, we patch the build scripts so Xcode doesn't complain.
      - name: Bypass Pod Install
        run: |
          cd ios
          echo "ðŸš« Skipping 'pod install' to avoid Private Repo errors..."
          
          # Remove the 'diff' check that crashes the build if Pods aren't synced
          find . -name "*.sh" -exec sed -i '' '/diff/d' {} +
          
          # Remove the check for Manifest.lock
          find . -name "*.sh" -exec sed -i '' '/Manifest.lock/d' {} +
          
          echo "âœ… Bypass complete. Using local Pods."

      # 3. IDENTITY SHIFT (Renames App & Fixes Tendies)
      - name: Apply Master Patch
        run: |
          cd ios
          echo "ðŸŽ¨ Starting Identity Shift..."

          # A. FIX TENDIES (.zip bug removal)
          # Removes the code that forces .zip extension so .tendies works
          find . -name "LEANWebViewController.m" -exec sed -i '' 's/stringByAppendingPathExtension:@"zip"//g' {} +
          find . -name "GNJSBridgeInterface.m" -exec sed -i '' 's/stringByAppendingPathExtension:@"zip"//g' {} +

          # B. RENAME APP & SET PERMISSIONS
          PLIST=$(find . -name "Info.plist" | head -n 1)
          
          if [ -n "$PLIST" ]; then
            echo "   ðŸ“ Editing $PLIST..."
            
            # Set Name to CAPlayground
            /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName CAPlayground" "$PLIST" 2>/dev/null || /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string CAPlayground" "$PLIST"
            
            # Set ID to com.nightvibes3.caplayground
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.nightvibes3.caplayground" "$PLIST"
            
            # Enable File Sharing (For dragging .tendies into the app)
            /usr/libexec/PlistBuddy -c "Add :UIFileSharingEnabled bool true" "$PLIST" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :UIFileSharingEnabled true" "$PLIST"
            /usr/libexec/PlistBuddy -c "Add :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST" 2>/dev/null || /usr/libexec/PlistBuddy -c "Set :LSSupportsOpeningDocumentsInPlace true" "$PLIST"
            
            echo "   âœ… Identity Shift Complete."
          fi

      # 4. BUILD APP (Unsigned / Performance Mode)
      - name: Build App
        run: |
          cd ios
          # Automatically find the Workspace
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME="CAPlayground" 
          
          echo "ðŸš€ Building $WORKSPACE..."
          
          xcodebuild build \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build/ \
            -arch arm64 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            SWIFT_COMPILATION_MODE=wholemodule

      # 5. PACKAGE IPA
      - name: Package IPA
        run: |
          cd ios
          mkdir Payload
          
          # Find the built .app file
          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Build failed. No .app found."
            exit 1
          fi
          
          cp -r "$APP_PATH" Payload/

          # Clean Signature (Vital for SideStore)
          rm -rf "Payload/$(basename "$APP_PATH")/_CodeSignature"
          
          IPA_NAME="CAPlayground_v6_IdentityShift.ipa"
          zip -r -y -X "$IPA_NAME" Payload

          echo "IPA_NAME=$IPA_NAME" >> $GITHUB_ENV

      # 6. UPLOAD
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: CAPlayground-IdentityShift-IPA
          path: ios/${{ env.IPA_NAME }}
