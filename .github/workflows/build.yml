name: CAPlayground V6 (PYTHON-FIXED)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # 1. EXTRACT SOURCE
      - name: Extract Source
        run: |
          if [ -f "ios_source.tar.gz" ]; then
            tar -xzf ios_source.tar.gz
          else
            echo "ðŸ“‚ Using existing folder."
          fi

      # 2. PYTHON SURGERY: Safe Replacement + Intercept Injection
      - name: Python Surgery
        shell: python
        run: |
          import os
          import base64

          # THE INTERCEPTOR CODE [web:101][web:103]
          interceptor = """
- (void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask didFinishDownloadingToURL:(NSURL *)location {
    NSString *suggested = downloadTask.response.suggestedFilename ?: @"export";
    NSString *name = [[suggested stringByDeletingPathExtension] stringByAppendingPathExtension:@"tendies"];
    NSURL *docs = [[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask].firstObject;
    NSURL *dest = [docs URLByAppendingPathComponent:name];
    [[NSFileManager defaultManager] moveItemAtURL:location toURL:dest error:nil];
}
"""
          handler = """
- (void)download:(nonnull WKDownload *)download decideDestinationUsingResponse:(nonnull NSURLResponse *)response suggestedFilename:(nonnull NSString *)suggestedFilename completionHandler:(nonnull void (^)(NSURL * _Nullable))completionHandler {
    NSString *fixedName = [[suggestedFilename stringByDeletingPathExtension] stringByAppendingPathExtension:@"tendies"];
    NSURL *documentsDir = [[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask].firstObject;
    NSURL *url = [documentsDir URLByAppendingPathComponent:fixedName];
    completionHandler(url);
}
"""
          # WALK AND FIX EVERY FILE [memory:18]
          for root, dirs, files in os.walk('.'):
              for file in files:
                  fpath = os.path.join(root, file)
                  if file.endswith(('.m', '.h', '.swift', '.pbxproj', '.plist')):
                      try:
                          with open(fpath, 'rb') as f:
                              content = f.read().decode('utf-8', 'ignore')
                          
                          # NUCLEAR SCRUB
                          new_content = content.replace('stringByAppendingPathExtension:@"zip"', 'stringByAppendingPathExtension:@"tendies"')
                          new_content = new_content.replace('@"zip"', '@"tendies"')
                          new_content = new_content.replace('application/zip', 'application/tendies')
                          
                          # PROJECT FIXES
                          if file == 'project.pbxproj':
                              new_content = '\n'.join([l for l in new_content.split('\n') if 'GoogleService-Info.plist' not in l])
                              new_content = new_content.replace('SDKROOT = iphonesimulator', 'SDKROOT = iphoneos')

                          # INJECT HANDLERS & DEBUG MODE [web:180][web:197]
                          if file == 'LEANWebViewController.m' and 'tendies' not in new_content:
                              new_content = new_content.replace('@end', interceptor + '\n' + handler + '\n@end')
                              debug_inject = 'if (@available(iOS 16.4, *)) { [self.wkWebview setInspectable:YES]; }'
                              new_content = new_content.replace('[self switchToWebView:wv showImmediately:NO];', '[self switchToWebView:wv showImmediately:NO];' + debug_inject)

                          if new_content != content:
                              with open(fpath, 'w', encoding='utf-8') as f:
                                  f.write(new_content)
                      except Exception as e:
                          print(f"Skipping {file} due to error: {e}")

      # 3. IDENTITY & PERMISSIONS (Files App Enable)
      - name: Apply Identity Patch
        run: |
          cd ios
          PLIST=$(find . -name "Info.plist" | head -n 1)
          if [ -n "$PLIST" ]; then
            /usr/libexec/PlistBuddy -c "Add :UIFileSharingEnabled bool true" "$PLIST" || true
            /usr/libexec/PlistBuddy -c "Add :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST" || true
          fi

      # 4. BUILD APP (REAL DEVICE)
      - name: Build App
        run: |
          cd ios
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME=$(xcodebuild -list -workspace "$WORKSPACE" | awk '/Schemes:/{flag=1; next} flag{print $1; exit}')
          xcodebuild build -workspace "$WORKSPACE" -scheme "$SCHEME" -sdk iphoneos -configuration Release -derivedDataPath build/ -arch arm64 CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      # 5. PACKAGE IPA
      - name: Package IPA
        run: |
          cd ios
          mkdir Payload
          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          cp -r "$APP_PATH" Payload/
          rm -rf "Payload/$(basename "$APP_PATH")/_CodeSignature"
          zip -r -y -X "CAPlayground_Tendies.ipa" Payload
          echo "IPA_NAME=CAPlayground_Tendies.ipa" >> $GITHUB_ENV

      # 6. UPLOAD
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: CAPlayground-Tendies-Final
          path: ios/CAPlayground_Tendies.ipa
