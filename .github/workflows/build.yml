name: CAPlayground V6 (Auto-Fix Real Device)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # 1. EXTRACT SOURCE
      - name: Extract Source
        run: |
          if [ -f "ios_source.tar.gz" ]; then
            tar -xzf ios_source.tar.gz
          else
            echo "ðŸ“‚ Using existing folder."
          fi

      # 2. AUTO-FIX: Add the Missing Download Handler
      - name: Add Missing Download Handler
        run: |
          cd ios
          echo "ðŸ”§ Adding WKDownloadDelegate handler to LEANWebViewController.m..."
          python3 << 'EOF'
          import os
          
          for root, dirs, files in os.walk('.'):
              if 'LEANWebViewController.m' in files:
                  filepath = os.path.join(root, 'LEANWebViewController.m')
                  with open(filepath, 'r') as f:
                      content = f.read()
                  
                  if 'decideDestinationUsingResponse' in content:
                      print(f"Handler already exists in {filepath}")
                  else:
                      handler_code = """
- (void)download:(nonnull WKDownload *)download 
decideDestinationUsingResponse:(nonnull NSURLResponse *)response 
suggestedFilename:(nonnull NSString *)suggestedFilename 
completionHandler:(nonnull void (^)(NSURL * _Nullable))completionHandler 
API_AVAILABLE(ios(15.0)) {
    NSString *fixedName = [suggestedFilename stringByDeletingPathExtension];
    fixedName = [fixedName stringByAppendingPathExtension:@"tendies"];
    NSURL *documentsDir = [[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask].firstObject;
    NSURL *url = [documentsDir URLByAppendingPathComponent:fixedName];
    completionHandler(url);
}
"""
                      if '@end' in content:
                          content = content.replace('@end', handler_code + '\n@end')
                          with open(filepath, 'w') as f:
                              f.write(content)
                          print(f"Added WKDownloadDelegate handler to {filepath}")
          EOF

      # 3. PROJECT SURGERY
      - name: Project Surgery
        run: |
          cd ios
          python3 << 'EOF'
          import os
          for root, dirs, files in os.walk('.'):
              if 'project.pbxproj' in files:
                  proj_path = os.path.join(root, 'project.pbxproj')
                  with open(proj_path, 'r') as f:
                      lines = f.readlines()
                  with open(proj_path, 'w') as f:
                      for line in lines:
                          if 'GoogleService-Info.plist' in line:
                              continue
                          line = line.replace('CODE_SIGNING_ALLOWED = YES', 'CODE_SIGNING_ALLOWED = NO')
                          line = line.replace('CODE_SIGNING_REQUIRED = YES', 'CODE_SIGNING_REQUIRED = NO')
                          line = line.replace('SDKROOT = iphonesimulator', 'SDKROOT = iphoneos')
                          f.write(line)
          EOF
          find . -name "*.sh" -exec sed -i '' '/diff/d' {} + || true
          find . -name "*.sh" -exec sed -i '' '/Manifest.lock/d' {} + || true

      # 4. IDENTITY & PERMISSIONS
      - name: Apply Identity Patch
        run: |
          cd ios
          PLIST=$(find . -name "Info.plist" | head -n 1)
          if [ -n "$PLIST" ]; then
            /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName CAPlayground" "$PLIST" || true
            /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.nightvibes3.caplayground" "$PLIST" || true
            /usr/libexec/PlistBuddy -c "Add :UIFileSharingEnabled bool true" "$PLIST" || true
            /usr/libexec/PlistBuddy -c "Add :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST" || true
          fi

      # 5. BUILD APP (REAL DEVICE)
      - name: Build App
        run: |
          cd ios
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" | head -n 1)
          SCHEME=$(xcodebuild -list -workspace "$WORKSPACE" | awk '/Schemes:/{flag=1; next} flag{print $1; exit}')
          
          xcodebuild build \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build/ \
            -arch arm64 \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO

      # 6. PACKAGE IPA
      - name: Package IPA
        run: |
          cd ios
          mkdir Payload
          APP_PATH=$(find build/Build/Products/Release-iphoneos -name "*.app" | head -n 1)
          if [ -z "$APP_PATH" ]; then echo "âŒ NO APP FOUND"; exit 1; fi
          
          cp -r "$APP_PATH" Payload/
          rm -rf "Payload/$(basename "$APP_PATH")/_CodeSignature"
          zip -r -y -X "CAPlayground_Final.ipa" Payload
          echo "IPA_PATH=ios/CAPlayground_Final.ipa" >> $GITHUB_ENV

      # 7. UPLOAD
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: CAPlayground-Real-Device-Fixed
          path: ios/CAPlayground_Final.ipa
