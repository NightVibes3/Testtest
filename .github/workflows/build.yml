name: Build iOS

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Extract Source
        run: |
          if [ -f "ios_source.tar.gz" ]; then
            tar -xzf ios_source.tar.gz
          fi

      # IMPORTANT: this format avoids YAML parser issues around multiline python blocks [web:330]
      - name: Python Surgery
        run: |
          python3 - <<'PY'
          import os

          interceptor = r'''
          - (void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask didFinishDownloadingToURL:(NSURL *)location {
              NSString *suggested = downloadTask.response.suggestedFilename ?: @"export";
              NSString *name = [[suggested stringByDeletingPathExtension] stringByAppendingPathExtension:@"tendies"];
              NSURL *docs = [[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask].firstObject;
              NSURL *dest = [docs URLByAppendingPathComponent:name];
              [[NSFileManager defaultManager] moveItemAtURL:location toURL:dest error:nil];
          }
          '''

          handler = r'''
          - (void)download:(nonnull WKDownload *)download decideDestinationUsingResponse:(nonnull NSURLResponse *)response suggestedFilename:(nonnull NSString *)suggestedFilename completionHandler:(nonnull void (^)(NSURL * _Nullable))completionHandler {
              NSString *fixedName = [[suggestedFilename stringByDeletingPathExtension] stringByAppendingPathExtension:@"tendies"];
              NSURL *documentsDir = [[NSFileManager defaultManager] URLsForDirectory:NSDocumentDirectory inDomains:NSUserDomainMask].firstObject;
              NSURL *url = [documentsDir URLByAppendingPathComponent:fixedName];
              completionHandler(url);
          }
          '''

          root_dir = "ios"
          for root, _, files in os.walk(root_dir):
              for fn in files:
                  if not fn.endswith((".m", ".h", ".swift", ".pbxproj", ".plist")):
                      continue
                  path = os.path.join(root, fn)

                  data = open(path, "rb").read()
                  text = data.decode("utf-8", "ignore")

                  new_text = text
                  new_text = new_text.replace('stringByAppendingPathExtension:@"zip"', 'stringByAppendingPathExtension:@"tendies"')
                  new_text = new_text.replace('@"zip"', '@"tendies"')
                  new_text = new_text.replace("application/zip", "application/tendies")

                  if fn == "project.pbxproj":
                      new_text = "\n".join([l for l in new_text.splitlines() if "GoogleService-Info.plist" not in l])
                      new_text = new_text.replace("SDKROOT = iphonesimulator", "SDKROOT = iphoneos")

                  if fn == "LEANWebViewController.m" and "setInspectable" not in new_text:
                      # safer: only inject debug if method exists; avoids compile errors on older SDKs [web:197]
                      debug = r'''
          if (@available(iOS 16.4, *)) {
              if ([self.wkWebview respondsToSelector:@selector(setInspectable:)]) {
                  [self.wkWebview performSelector:@selector(setInspectable:) withObject:@YES];
              }
          }
                      '''
                      new_text = new_text.replace("@end", f"{interceptor}\n{handler}\n@end")
                      new_text = new_text.replace("[self switchToWebView:wv showImmediately:NO];",
                                                  "[self switchToWebView:wv showImmediately:NO];\n" + debug)

                  if new_text != text:
                      open(path, "w", encoding="utf-8").write(new_text)
          PY

      - name: Apply Identity Patch
        run: |
          cd ios
          PLIST="$(find . -name Info.plist | head -n 1)"
          if [ -n "$PLIST" ]; then
            /usr/libexec/PlistBuddy -c "Add :UIFileSharingEnabled bool true" "$PLIST" || true
            /usr/libexec/PlistBuddy -c "Add :LSSupportsOpeningDocumentsInPlace bool true" "$PLIST" || true
          fi

      - name: Build App (no signing)
        run: |
          cd ios
          WORKSPACE="$(find . -maxdepth 1 -name '*.xcworkspace' | head -n 1)"
          SCHEME="$(xcodebuild -list -workspace "$WORKSPACE" | awk '/Schemes:/{flag=1; next} flag{print $1; exit}')"
          xcodebuild build \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build/ \
            -arch arm64 \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO

      - name: Package IPA
        run: |
          cd ios
          rm -rf Payload
          mkdir -p Payload
          APP_PATH="$(find build/Build/Products/Release-iphoneos -name '*.app' | head -n 1)"
          cp -r "$APP_PATH" Payload/
          rm -rf "Payload/$(basename "$APP_PATH")/_CodeSignature" || true
          /usr/bin/zip -r -y -X CAPlayground_Tendies.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: CAPlayground
          path: ios/CAPlayground_Tendies.ipa
